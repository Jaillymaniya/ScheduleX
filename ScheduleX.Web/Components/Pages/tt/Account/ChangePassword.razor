@page "/tt/account/change-password"
@layout ScheduleX.Web.Components.Layout.tt.TTLayout

@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@inject ScheduleX.Infrastructure.Data.AppDbContext Db
@inject ScheduleX.Web.Services.AuthState Auth
@inject ScheduleX.Web.Services.PasswordHasher Hasher
@inject NavigationManager Nav

<div class="tt-page-head">
    <div>
        <h2 class="tt-h2">Change Password</h2>
        <p class="tt-muted">Enter old password and set a new password.</p>
    </div>
    <div class="tt-head-actions">
        <button class="tt-btn" @onclick="@(()=>Nav.NavigateTo("/tt/account/profile"))">Back to Profile</button>
    </div>
</div>

<div class="tt-form-wrapper">
<div class="tt-card">
    <div class="tt-card-top">
        <div class="tt-card-title">Update Password</div>
        <div class="tt-muted">Minimum 8 characters recommended.</div>
    </div>

    <EditForm Model="Model" OnValidSubmit="DoChangePassword">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="tt-form-grid">
            <div class="tt-field" style="grid-column:1/-1;">
                <div class="tt-label">Old Password</div>
                <InputText class="tt-input" type="password" @bind-Value="Model.OldPassword" />
            </div>

            <div class="tt-field">
                <div class="tt-label">New Password</div>
                <InputText class="tt-input" type="password" @bind-Value="Model.NewPassword" />
            </div>

            <div class="tt-field">
                <div class="tt-label">Confirm New Password</div>
                <InputText class="tt-input" type="password" @bind-Value="Model.ConfirmPassword" />
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Message))
        {
            <div class="tt-alertbar @(MessageType)">@Message</div>
        }

        <div class="tt-actions-row">
            <button type="submit" class="tt-btn primary" disabled="@Saving">
                @(Saving ? "Updating..." : "Update Password")
            </button>
            <button type="button" class="tt-btn" @onclick="Clear" disabled="@Saving">Clear</button>
        </div>
    </EditForm>
</div>
</div>
@code {
    bool Saving = false;

    string? Message;
    string MessageType = "success";

    ChangePasswordVm Model = new();

    protected override void OnInitialized()
    {
        if (!Auth.IsLoggedIn)
        {
            Nav.NavigateTo("/login", replace: true);
        }
    }

    async Task DoChangePassword()
    {
        Message = null;

        if (Model.NewPassword != Model.ConfirmPassword)
        {
            MessageType = "warn";
            Message = "New password and confirm password do not match.";
            return;
        }

        Saving = true;

        try
        {
            var user = await Db.Users.FirstOrDefaultAsync(x => x.UserId == Auth.UserId!.Value && x.IsActive);

            if (user == null)
            {
                MessageType = "error";
                Message = "User record not found or inactive.";
                return;
            }

            if (!Hasher.Verify(Model.OldPassword ?? "", user.PasswordHash))
            {
                MessageType = "error";
                Message = "Old password is incorrect.";
                return;
            }

            user.PasswordHash = Hasher.Hash(Model.NewPassword!);
            await Db.SaveChangesAsync();

            MessageType = "success";
            Message = "Password updated successfully ✅";

            // If you want auto logout after change, tell me and I'll add it.
            Clear();
        }
        catch (Exception ex)
        {
            MessageType = "error";
            Message = "Password update failed: " + ex.Message;
        }
        finally
        {
            Saving = false;
        }
    }

    void Clear()
    {
        Model = new ChangePasswordVm();
    }

    public class ChangePasswordVm
    {
        [Required]
        public string? OldPassword { get; set; }

        [Required, MinLength(8), MaxLength(50)]
        public string? NewPassword { get; set; }

        [Required, MinLength(8), MaxLength(50)]
        public string? ConfirmPassword { get; set; }
    }
}